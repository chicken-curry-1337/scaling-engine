# Докеризация приложения

Репозиторий содержит полностью докеризированные фронтенд и бэкенд сервисы КупиПодариДай, а также готовый docker-compose стек с PostgreSQL.

## Переменные окружения

1. Скопируйте `.env.example` в `.env`.
2. Обновите значения:
   - `DB_*`, `POSTGRES_*` — параметры подключения бэкенда к базе и конфигурация контейнера PostgreSQL.
   - `FRONTEND_HTTP_PORT` / `FRONTEND_HTTPS_PORT` — внешние порты, которые будут проброшены к nginx (для LetsEncrypt укажите `80` и `443`).
   - `ENABLE_SSL`, `SERVER_NAME`, `LETSENCRYPT_EMAIL`, `CERTBOT_RENEW_INTERVAL` и `LETSENCRYPT_USE_STAGING` — управление автоматической выдачей и продлением сертификатов.

## Запуск локально

```bash
docker compose up --build
```

Стек поднимет все три сервиса, зависимости между контейнерами уже описаны в `docker-compose.yml`.

## Настройка HTTPS через Let's Encrypt

Финальный образ фронтенда основан на `nginx:latest` и содержит встроенный скрипт, который умеет:

- обслуживать HTTP-трафик и отдавать React-приложение;
- автоматически запрашивать сертификат Let's Encrypt через webroot-челлендж;
- переключать конфигурацию nginx на HTTPS и поддерживать переадресацию с HTTP;
- выполнять регулярное обновление сертификатов (интервал управляется `CERTBOT_RENEW_INTERVAL`, по умолчанию 12 часов) и перезагружать nginx после успешного продления;
- хранить все ключи и цепочки в томе `letsencrypt_data`, чтобы сертификаты не пропадали при пересборке контейнера.

Чтобы включить HTTPS на сервере:

1. Убедитесь, что DNS-запись указывает на ваш сервер и что порты 80/443 открыты наружу (`FRONTEND_HTTP_PORT=80`, `FRONTEND_HTTPS_PORT=443`).
2. В `.env` выставьте `ENABLE_SSL=true`, пропишите реальный `SERVER_NAME` (домен) и `LETSENCRYPT_EMAIL`.
3. (Опционально) во время тестов включите `LETSENCRYPT_USE_STAGING=true`, чтобы избежать продовых лимитов.
4. Выполните `docker compose up -d frontend`. Скрипт внутри контейнера сам запросит сертификат и переключит nginx на HTTPS после успешного выпуска.
5. Следите за логами `docker compose logs -f frontend` — там появится информация о состоянии ACME-запроса.

Повторно запускать certbot вручную не нужно — обновление выполняется автоматически.
